{% extends "layouts/main.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header pb-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">{{ application.name }}</h6>
                            <p class="text-sm mb-0">{{ application.code_name }}</p>
                        </div>
                        <div class="d-flex gap-2">
                            {% if can_edit %}
                            <a href="{% url 'envanter:application_update' application.pk %}" class="btn btn-primary btn-sm">
                                <i class="fas fa-edit me-1"></i>Düzenle
                            </a>
                            {% endif %}
                            {% if can_delete %}
                            <a href="{% url 'envanter:application_delete' application.pk %}" class="btn btn-danger btn-sm">
                                <i class="fas fa-trash me-1"></i>Sil
                            </a>
                            {% endif %}
                            <a href="{% url 'envanter:inventory_list' %}" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-arrow-left me-1"></i>Geri
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Info Cards -->
                <div class="card-body">
                    <div class="row">
                        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
                            <div class="card">
                                <div class="card-body p-3">
                                    <div class="row">
                                        <div class="col-8">
                                            <div class="numbers">
                                                <p class="text-sm mb-0 text-capitalize font-weight-bold">Durum</p>
                                                <h5 class="font-weight-bolder mb-0">
                                                    <span class="badge {{ application.get_status_badge_class }}">
                                                        {{ application.get_status_display }}
                                                    </span>
                                                </h5>
                                            </div>
                                        </div>
                                        <div class="col-4 text-end">
                                            <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                                                <i class="fas fa-info-circle text-lg opacity-10"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
                            <div class="card">
                                <div class="card-body p-3">
                                    <div class="row">
                                        <div class="col-8">
                                            <div class="numbers">
                                                <p class="text-sm mb-0 text-capitalize font-weight-bold">Sağlık</p>
                                                <h5 class="font-weight-bolder mb-0">
                                                    <span class="badge {{ application.get_health_status_badge_class }}">
                                                        {{ application.get_health_check_status_display|default:"Bilinmiyor" }}
                                                    </span>
                                                </h5>
                                            </div>
                                        </div>
                                        <div class="col-4 text-end">
                                            <div class="icon icon-shape bg-gradient-success shadow text-center border-radius-md">
                                                <i class="fas fa-heartbeat text-lg opacity-10"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
                            <div class="card">
                                <div class="card-body p-3">
                                    <div class="row">
                                        <div class="col-8">
                                            <div class="numbers">
                                                <p class="text-sm mb-0 text-capitalize font-weight-bold">Kritiklik</p>
                                                <h5 class="font-weight-bolder mb-0">
                                                    {% if application.business_criticality == 'critical' %}
                                                    <span class="badge bg-gradient-danger">Kritik</span>
                                                    {% elif application.business_criticality == 'high' %}
                                                    <span class="badge bg-gradient-warning">Yüksek</span>
                                                    {% elif application.business_criticality == 'medium' %}
                                                    <span class="badge bg-gradient-info">Orta</span>
                                                    {% else %}
                                                    <span class="badge bg-gradient-secondary">Düşük</span>
                                                    {% endif %}
                                                </h5>
                                            </div>
                                        </div>
                                        <div class="col-4 text-end">
                                            <div class="icon icon-shape bg-gradient-warning shadow text-center border-radius-md">
                                                <i class="fas fa-exclamation-triangle text-lg opacity-10"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-sm-6">
                            <div class="card">
                                <div class="card-body p-3">
                                    <div class="row">
                                        <div class="col-8">
                                            <div class="numbers">
                                                <p class="text-sm mb-0 text-capitalize font-weight-bold">Sunucu Sayısı</p>
                                                <h5 class="font-weight-bolder mb-0">{{ application.servers.count }}</h5>
                                            </div>
                                        </div>
                                        <div class="col-4 text-end">
                                            <div class="icon icon-shape bg-gradient-info shadow text-center border-radius-md">
                                                <i class="fas fa-server text-lg opacity-10"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabbed Content -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header pb-0">
                    <ul class="nav nav-tabs" id="applicationTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" 
                                    data-bs-target="#overview" type="button" role="tab">
                                <i class="fas fa-info-circle me-1"></i>Genel Bakış
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="servers-tab" data-bs-toggle="tab" 
                                    data-bs-target="#servers" type="button" role="tab">
                                <i class="fas fa-server me-1"></i>Sunucular
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="certificates-tab" data-bs-toggle="tab" 
                                    data-bs-target="#certificates" type="button" role="tab">
                                <i class="fas fa-certificate me-1"></i>Sertifikalar
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="operations-tab" data-bs-toggle="tab" 
                                    data-bs-target="#operations" type="button" role="tab">
                                <i class="fas fa-history me-1"></i>Operasyon Geçmişi
                            </button>
                        </li>
                        {% if related_articles %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="articles-tab" data-bs-toggle="tab" 
                                    data-bs-target="#articles" type="button" role="tab">
                                <i class="fas fa-book me-1"></i>İlgili Makaleler
                            </button>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                
                <div class="card-body">
                    <div class="tab-content" id="applicationTabsContent">
                        <!-- Overview Tab -->
                        <div class="tab-pane fade show active" id="overview" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-uppercase text-body text-xs font-weight-bolder">Temel Bilgiler</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <tbody>
                                                <tr>
                                                    <td class="text-sm font-weight-bold">Uygulama Adı:</td>
                                                    <td class="text-sm">{{ application.name }}</td>
                                                </tr>
                                                <tr>
                                                    <td class="text-sm font-weight-bold">Kod Adı:</td>
                                                    <td class="text-sm">{{ application.code_name }}</td>
                                                </tr>
                                                <tr>
                                                    <td class="text-sm font-weight-bold">Versiyon:</td>
                                                    <td class="text-sm">{{ application.version|default:"Belirtilmemiş" }}</td>
                                                </tr>
                                                <tr>
                                                    <td class="text-sm font-weight-bold">Ortam:</td>
                                                    <td class="text-sm">{{ application.environment.name }}</td>
                                                </tr>
                                                <tr>
                                                    <td class="text-sm font-weight-bold">Uygulama Tipi:</td>
                                                    <td class="text-sm">{{ application.application_type.name|default:"Belirtilmemiş" }}</td>
                                                </tr>
                                                <tr>
                                                    <td class="text-sm font-weight-bold">Sahip:</td>
                                                    <td class="text-sm">{{ application.owner.get_full_name|default:application.owner.username }}</td>
                                                </tr>
                                                <tr>
                                                    <td class="text-sm font-weight-bold">Sorumlu Takım:</td>
                                                    <td class="text-sm">{{ application.responsible_team|default:"Belirtilmemiş" }}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-uppercase text-body text-xs font-weight-bolder">Teknik Detaylar</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <tbody>
                                                <tr>
                                                    <td class="text-sm font-weight-bold">Port:</td>
                                                    <td class="text-sm">{{ application.port|default:"Belirtilmemiş" }}</td>
                                                </tr>
                                                <tr>
                                                    <td class="text-sm font-weight-bold">SSL Aktif:</td>
                                                    <td class="text-sm">
                                                        {% if application.ssl_enabled %}
                                                        <span class="badge bg-gradient-success">Evet</span>
                                                        {% else %}
                                                        <span class="badge bg-gradient-secondary">Hayır</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="text-sm font-weight-bold">Monitoring:</td>
                                                    <td class="text-sm">
                                                        {% if application.monitoring_enabled %}
                                                        <span class="badge bg-gradient-success">Aktif</span>
                                                        {% else %}
                                                        <span class="badge bg-gradient-secondary">Pasif</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="text-sm font-weight-bold">Son Sağlık Kontrol:</td>
                                                    <td class="text-sm">
                                                        {% if application.last_health_check %}
                                                        {{ application.last_health_check|date:"d.m.Y H:i" }}
                                                        {% else %}
                                                        Hiç yapılmamış
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="text-sm font-weight-bold">Oluşturma:</td>
                                                    <td class="text-sm">{{ application.created_at|date:"d.m.Y H:i" }}</td>
                                                </tr>
                                                <tr>
                                                    <td class="text-sm font-weight-bold">Son Güncelleme:</td>
                                                    <td class="text-sm">{{ application.updated_at|date:"d.m.Y H:i" }}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            {% if application.description %}
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h6 class="text-uppercase text-body text-xs font-weight-bolder">Açıklama</h6>
                                    <p class="text-sm">{{ application.description }}</p>
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Technologies -->
                            {% if application.technologies.exists %}
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h6 class="text-uppercase text-body text-xs font-weight-bolder">Teknolojiler</h6>
                                    <div class="d-flex flex-wrap gap-2">
                                        {% for tech in application.technologies.all %}
                                        <span class="badge bg-gradient-info">{{ tech.name }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Links -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h6 class="text-uppercase text-body text-xs font-weight-bolder">Bağlantılar</h6>
                                    <div class="d-flex gap-3">
                                        {% if application.documentation_url %}
                                        <a href="{{ application.documentation_url }}" target="_blank" class="btn btn-outline-info btn-sm">
                                            <i class="fas fa-book me-1"></i>Dokümantasyon
                                        </a>
                                        {% endif %}
                                        {% if application.repository_url %}
                                        <a href="{{ application.repository_url }}" target="_blank" class="btn btn-outline-secondary btn-sm">
                                            <i class="fab fa-git-alt me-1"></i>Repository
                                        </a>
                                        {% endif %}
                                        {% if application.port %}
                                        {% with primary_server=application.get_primary_server %}
                                        {% if primary_server %}
                                        <a href="{{ application.get_full_url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-external-link-alt me-1"></i>Uygulamaya Git
                                        </a>
                                        {% endif %}
                                        {% endwith %}
                                        {% endif %}
                                        <button class="btn btn-outline-success btn-sm" onclick="checkApplicationHealth()">
                                            <i class="fas fa-heartbeat me-1"></i>Sağlık Kontrol
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Servers Tab -->
                        <div class="tab-pane fade" id="servers" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table align-items-center mb-0">
                                    <thead>
                                        <tr>
                                            <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Sunucu</th>
                                            <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">IP Adresi</th>
                                            <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Durum</th>
                                            <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">İşletim Sistemi</th>
                                            <th class="text-secondary opacity-7"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for server in application.servers.all %}
                                        <tr>
                                            <td>
                                                <div class="d-flex px-2 py-1">
                                                    <div>
                                                        <div class="icon icon-shape icon-sm shadow border-radius-md bg-gradient-dark">
                                                            <i class="fas fa-server text-white opacity-10"></i>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex flex-column justify-content-center ms-3">
                                                        <h6 class="mb-0 text-sm">{{ server.hostname }}</h6>
                                                        <p class="text-xs text-secondary mb-0">{{ server.purpose|default:"" }}</p>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <p class="text-xs font-weight-bold mb-0">{{ server.ip_address }}</p>
                                            </td>
                                            <td class="align-middle text-center text-sm">
                                                <span class="badge badge-sm {{ server.get_status_badge_class }}">
                                                    {{ server.get_status_display }}
                                                </span>
                                            </td>
                                            <td class="align-middle text-center">
                                                <span class="text-secondary text-xs font-weight-bold">
                                                    {{ server.operating_system.name|default:"N/A" }}
                                                </span>
                                            </td>
                                            <td class="align-middle">
                                                <a href="{% url 'envanter:server_detail' server.id %}" class="btn btn-link text-secondary mb-0">
                                                    <i class="fas fa-eye text-xs"></i>
                                                </a>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="5" class="text-center py-4">
                                                <p class="text-secondary mb-0">Bu uygulamaya atanmış sunucu bulunmuyor.</p>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Certificates Tab -->
                        <div class="tab-pane fade" id="certificates" role="tabpanel">
                            <div class="text-center py-5">
                                <i class="fas fa-certificate fa-3x text-secondary mb-3"></i>
                                <h5 class="text-secondary">Sertifika Yönetimi</h5>
                                <p class="text-sm text-secondary">SSL sertifika bilgileri ve yönetimi burada görüntülenecek.</p>
                                <small class="text-muted">Bu özellik gelecek sürümlerde eklenecek.</small>
                            </div>
                        </div>
                        
                        <!-- Operations Tab -->
                        <div class="tab-pane fade" id="operations" role="tabpanel">
                            {% if operation_history %}
                            <div class="timeline timeline-one-side">
                                {% for operation in operation_history %}
                                <div class="timeline-block mb-3">
                                    <span class="timeline-step">
                                        <i class="fas fa-cog text-success text-gradient"></i>
                                    </span>
                                    <div class="timeline-content">
                                        <h6 class="text-dark text-sm font-weight-bold mb-0">{{ operation.title }}</h6>
                                        <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">{{ operation.date }}</p>
                                        <p class="text-sm mt-3 mb-2">{{ operation.description }}</p>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-history fa-3x text-secondary mb-3"></i>
                                <h5 class="text-secondary">Operasyon Geçmişi</h5>
                                <p class="text-sm text-secondary">Bu uygulama için henüz operasyon kaydı bulunmuyor.</p>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Articles Tab -->
                        {% if related_articles %}
                        <div class="tab-pane fade" id="articles" role="tabpanel">
                            <div class="row">
                                {% for article in related_articles %}
                                <div class="col-md-6 mb-4">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title">{{ article.title }}</h6>
                                            <p class="card-text text-sm">{{ article.summary|default:article.content|truncatewords:20 }}</p>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <small class="text-muted">{{ article.created_at|date:"d.m.Y" }}</small>
                                                <a href="{% url 'askgt:article_detail' article.pk %}" class="btn btn-primary btn-sm">
                                                    Oku
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Health Check Modal -->
<div class="modal fade" id="healthCheckModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sağlık Kontrol Sonucu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="healthCheckResult">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Kontrol ediliyor...</span>
                    </div>
                    <p class="mt-2">Sağlık kontrolü yapılıyor...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function checkApplicationHealth() {
    const modal = new bootstrap.Modal(document.getElementById('healthCheckModal'));
    const resultDiv = document.getElementById('healthCheckResult');
    
    // Show loading
    resultDiv.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Kontrol ediliyor...</span>
            </div>
            <p class="mt-2">Sağlık kontrolü yapılıyor...</p>
        </div>
    `;
    
    modal.show();
    
    // Make AJAX request
    fetch(`/envanter/ajax/uygulama/{{ application.pk }}/saglik-kontrol/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const badgeClass = data.badge_class || 'bg-secondary';
                const statusText = data.status === 'healthy' ? 'Sağlıklı' : 
                                 data.status === 'unhealthy' ? 'Sağlıksız' : 'Bilinmiyor';
                const iconClass = data.status === 'healthy' ? 'fa-check-circle text-success' : 
                                 data.status === 'unhealthy' ? 'fa-times-circle text-danger' : 
                                 'fa-question-circle text-warning';
                
                resultDiv.innerHTML = `
                    <div class="text-center">
                        <i class="fas ${iconClass} fa-3x mb-3"></i>
                        <h5>Durum: <span class="badge ${badgeClass}">${statusText}</span></h5>
                        ${data.last_check ? `<p class="text-sm text-secondary">Son kontrol: ${new Date(data.last_check).toLocaleString('tr-TR')}</p>` : ''}
                    </div>
                `;
                
                // Update page status if needed
                location.reload();
            } else {
                resultDiv.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h5>Hata</h5>
                        <p class="text-danger">${data.error}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            resultDiv.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                    <h5>Bağlantı Hatası</h5>
                    <p class="text-danger">Sağlık kontrolü yapılamadı.</p>
                </div>
            `;
        });
}
</script>
{% endblock %}
